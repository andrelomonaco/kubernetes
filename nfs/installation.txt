
Minimal Recommended Harbor Server

Resource	  Minimum	Recommended
CPU	        2 CPU
Mem	        8 GB
Disk	      60 GB
Disk without LVM

# Based on this article with some little changes
https://hbayraktar.medium.com/how-to-setup-dynamic-nfs-provisioning-in-a-kubernetes-cluster-cbf433b7de29

# A) Prerequisites installation

# cloud-init is a tool for automatically initializing and customizing an instance of a Linux distribution.
# Create an empty file to prevent the service from starting  

sudo touch /etc/cloud/cloud-init.disabled

sudo apt update && sudo apt -y full-upgrade
sudo reboot

# Step 1: Installing the NFS Server

sudo apt-get update
sudo apt-get install nfs-common nfs-kernel-server -y

# Create a directory to export:

sudo mkdir -p /data/nfs
sudo chown nobody:nogroup /data/nfs
sudo chmod 2770 /data/nfs

# Applying chmod 2770 to a directory that is being exported as an NFS share ensures that:

Group Collaboration: All files and subdirectories created within that share will automatically
belong to the same group as the share itself, facilitating group collaboration.

Controlled Access: Only the owner and the defined group have full access (read, write, execute), 
while "others" have no access, providing a level of security.

# Export directory
# Replace NETWORK

export NETWORK=192.168.254.0/24

echo -e "/data/nfs\t${NETWORK}(rw,sync,no_subtree_check,no_root_squash)" | sudo tee -a /etc/exports
sudo exportfs -av

# Restart NFS service:

sudo systemctl restart nfs-kernel-server
sudo systemctl status nfs-kernel-server

# Show Export Details:

MY_IP= ip -4 addr show scope global | awk '$1 == "inet" {print $2}'
/sbin/showmount -e ${MY_IP}

# Enable Firewall

sudo ufw allow 22/tcp
sudo ufw allow from 192.168.254.0/24 to any port nfs
sudo ufw --force enable
sudo ufw status

Step 2: Install NFS client packages on K8s Nodes
Make sure all your Kubernetes nodes have the NFS client packages installed. On Ubuntu-based nodes, install nfs-common:

sudo apt update
sudo apt install nfs-common -y

Step 3: Install and Configure NFS Client Provisioner
Deploy the NFS Subdir External Provisioner in your Kubernetes cluster to automate the creation and management 
of NFS-backed Persistent Volumes (PVs) and Persistent Volume Claims (PVCs).
https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner

NFS provisioner limitations/pitfalls

The provisioned storage is not guaranteed. You may allocate more than the NFS share's total size. 
The share may also not have enough storage space left to actually accommodate the request.
The provisioned storage limit is not enforced. The application can expand to use all the available storage regardless of the provisioned size.
Storage resize/expansion operations are not presently supported in any form. You will end up in an error state: 
Ignoring the PVC: didn't find a plugin capable of expanding the volume; waiting for an external controller to process this PVC.

Add Helm Repository for nfs-subdir-external-provisioner:
helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner

Install Helm Chart for NFS

export NFS_SERVER_IP=192.168.254.227

helm install nfs-subdir-external-provisioner \
nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
--set nfs.server=${NFS_SERVER_IP} \
--set nfs.path=/data/nfs \
--set storageClass.onDelete=true \
-n nfs-provisioner --create-namespace

# Check pods and storage classes:
kubectl get pod -n nfs-provisioner
kubectl get sc

# Deploy the test resources:

kubectl create -f https://raw.githubusercontent.com/kubernetes-sigs/nfs-subdir-external-provisioner/master/deploy/test-claim.yaml -f https://raw.githubusercontent.com/kubernetes-sigs/nfs-subdir-external-provisioner/master/deploy/test-pod.yaml

# Now check your NFS Server for the SUCCESS inside the PVC's directory.

# Delete the test resources

kubectl delete -f https://raw.githubusercontent.com/kubernetes-sigs/nfs-subdir-external-provisioner/master/deploy/test-claim.yaml -f https://raw.githubusercontent.com/kubernetes-sigs/nfs-subdir-external-provisioner/master/deploy/test-pod.yaml











